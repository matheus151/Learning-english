<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pro - V22 Gender Voice & Smart Fix</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #334155;
            --line-font-size: 1.15rem; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            max-width: 700px;
            margin: 0 auto;
            padding: 30px 20px;
            padding-bottom: 150px;
            font-weight: 400;
        }

        /* Nav Flutuante */
        .nav-float {
            position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100;
        }
        .nav-btn {
            background: rgba(37, 99, 235, 0.9); color: white; border: none; border-radius: 50%; width: 45px; height: 45px;
            font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; transition: transform 0.2s;
        }
        .nav-btn:hover { transform: scale(1.1); background: var(--primary); }

        /* Header */
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #1e293b; font-weight: 700; font-size: 1.8rem; }
        .font-controls { display: flex; gap: 5px; background: #fff; padding: 5px; border-radius: 8px; border: 1px solid #cbd5e1; }
        .font-btn { background: #f1f5f9; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; color: #475569; font-size: 1rem; }
        .font-btn:hover { background: var(--primary); color: white; }

        /* Destaques */
        .hl-base { padding: 0 4px; border-radius: 4px; display: inline-block; }
        .hl-blue { color: #0284c7; background-color: #e0f2fe; font-weight: 700; }
        .hl-red { color: #dc2626; background-color: #fee2e2; font-weight: 700; }
        .hl-lilac { color: #9333ea; background-color: #f3e8ff; font-weight: 700; }
        .hl-bold { font-weight: 900; color: #000; border-bottom: 2px solid #cbd5e1; }

        /* Formul√°rio */
        .input-group { background: var(--card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .input-group h3 { margin-top: 0; color: #1e293b; font-size: 1.25rem; margin-bottom: 20px; font-weight: 600; }
        .input-row { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #64748b; }
        textarea, input[type="text"] { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; font-family: 'Inter', sans-serif; resize: vertical; background-color: #fff; color: #334155; box-sizing: border-box; }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        button { font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.2s; }
        button#add-btn { background-color: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; width: 100%; font-size: 1.05rem; margin-top: 10px; }
        .translate-action-btn { background-color: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; font-weight: 500; margin-bottom: 10px; }

        /* Data Controls */
        .data-controls { display: flex; gap: 10px; margin-bottom: 30px; background: #334155; padding: 10px; border-radius: 10px; color: white; align-items: center; justify-content: center; flex-wrap: wrap; }
        .data-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .data-btn:hover { background: rgba(255,255,255,0.2); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.5); color: #fca5a5; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.8); color: white; }
        #file-input { display: none; }

        /* Importa√ß√£o */
        .import-toggle { text-align: center; margin-bottom: 25px; }
        .import-link { color: #64748b; text-decoration: none; border-bottom: 1px dashed #94a3b8; background: none; border: none; font-size: 0.9rem; }
        #import-section { display: none; background: #fff; padding: 20px; border-radius: 12px; border: 2px dashed #cbd5e1; margin-bottom: 30px; }

        /* Cart√µes */
        #card-container { display: flex; flex-direction: column; gap: 20px; }
        .card { 
            background: var(--card-bg); padding: 25px; border-radius: 16px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.04); 
            border-left-width: 6px; border-left-style: solid;
            animation: fadeIn 0.4s ease-out; position: relative; scroll-margin-top: 20px; padding-top: 35px; 
        }
        
        .card-number { position: absolute; top: 10px; left: 15px; font-size: 0.85rem; color: #94a3b8; font-weight: 600; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; }
        .card-top-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 10; }
        .edit-btn { background: #f1f5f9; color: #475569; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        
        .phrases-area { margin-right: 40px; }

        .line-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f1f5f9; }
        .line-item:last-child { border-bottom: none; }
        .line-text { font-size: var(--line-font-size); color: #1e293b; flex-grow: 1; line-height: 1.6; margin-top: 4px; transition: font-size 0.2s; word-wrap: break-word; }
        .play-mini { background: #eff6ff; border: none; color: var(--primary); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-size: 1.1rem; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; flex-wrap: wrap; gap: 10px; }
        .controls-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .control-label { font-size: 0.8rem; color: #64748b; font-weight: 600; margin-right: 2px;}
        select.control-select { padding: 6px; border-radius: 6px; border: 1px solid #cbd5e1; background: #fff; font-size: 0.9rem; cursor: pointer; }
        .play-all-btn { background: none; border: 1px solid #cbd5e1; border-radius: 20px; padding: 6px 12px; font-size: 0.85rem; font-weight: 600; color: #475569; }
        .delete-btn { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 1.2rem; opacity: 0.7; }
        
        .toggle-btn { background: none; border: none; color: #64748b; cursor: pointer; width: 100%; padding: 10px; margin-top: 5px; font-size: 0.9rem; font-weight: 500; }
        .details-area { display: none; background-color: #f0fdf4; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px solid #bbf7d0; }
        .details-area.visible { display: block; }
        .translation-text { color: #15803d; white-space: pre-line; line-height: 1.6; font-size: 1rem; }

        .edit-mode-area { background: #f8fafc; padding: 10px; border-radius: 8px; border: 2px solid #cbd5e1; margin-bottom: 10px; line-height: 1.6; }
        .edit-toolbar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
        
        .color-btn { border: 1px solid #cbd5e1; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 3px; background: #fff; transition: 0.2s; }
        .btn-blue { color: #0284c7; background: #eff6ff; border-color: #bfdbfe; }
        .btn-red { color: #dc2626; background: #fef2f2; border-color: #fecaca; }
        .btn-lilac { color: #9333ea; background: #faf5ff; border-color: #e9d5ff; }
        .btn-bold { color: #000; background: #f1f5f9; border-color: #94a3b8; }
        .btn-smart { background: #334155; color: white; border: 1px solid #1e293b; }
        .btn-smart:hover { background: #1e293b; }
        .btn-secondary { background: #e2e8f0; color: #334155; border: 1px solid #cbd5e1; }
        .btn-secondary:hover { background: #cbd5e1; }

        .save-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;}
        .cancel-btn { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;}

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="nav-float">
        <button class="nav-btn" onclick="scrollToTop()">‚¨Ü</button>
        <button class="nav-btn" onclick="scrollToBottom()">‚¨á</button>
    </div>

    <div class="header-container">
        <h1>üá¨üáß English Pro</h1>
        <div class="font-controls">
            <button class="font-btn" onclick="changeFontSize(-0.1)">A-</button>
            <button class="font-btn" onclick="changeFontSize(0.1)">A+</button>
        </div>
    </div>

    <div class="input-group">
        <h3>Nova Entrada</h3>
        <div class="input-row">
            <label>Frases em Ingl√™s</label>
            <textarea id="input-phrase" rows="4" placeholder="Cole aqui seu texto..."></textarea>
        </div>
        <div class="input-row">
            <label>Tradu√ß√£o</label>
            <textarea id="input-translation" rows="4" placeholder="..."></textarea>
        </div>
        <button class="translate-action-btn" onclick="translateForm()">ü™Ñ Traduzir Campos Acima</button>
        <button id="add-btn" onclick="addCard()">Salvar Cart√£o</button>
    </div>

    <div class="data-controls">
        <button class="data-btn" onclick="downloadBackup()">üíæ Fazer Backup</button>
        <button class="data-btn" onclick="document.getElementById('file-input').click()">üìÇ Restaurar</button>
        <button class="data-btn btn-danger" onclick="clearAllData()">üóëÔ∏è Zerar App</button>
        <input type="file" id="file-input" accept=".json" onchange="restoreBackup(this)">
    </div>

    <div class="import-toggle">
        <button class="import-link" onclick="toggleImportArea()">‚¨á Colar Texto Longo</button>
    </div>
    <div id="import-section">
        <textarea id="import-area" rows="6" placeholder="Blocos separados por linha em branco..."></textarea>
        <button id="add-btn" style="background-color: #64748b;" onclick="processBulkImport()">Processar</button>
    </div>

    <div id="card-container"></div>

    <script>
        let cards = [];
        let voices = [];
        let currentFontSize = 1.15; 
        
        const borderColors = ['#2563eb', '#dc2626', '#16a34a', '#d97706', '#9333ea', '#0891b2'];
        const STORAGE_KEY = 'englishCardsFinalV22';

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const index = entry.target.id.replace('card-', '');
                    localStorage.setItem('englishAppLastPos', index);
                }
            });
        }, { threshold: 0.6 });

        window.speechSynthesis.onvoiceschanged = () => { voices = window.speechSynthesis.getVoices(); };

        // --- L√ìGICA DE VOZ COM PREFER√äNCIA DE G√äNERO ---
        function getVoiceByAccent(accent) {
            if (voices.length === 0) voices = window.speechSynthesis.getVoices();
            
            const isUS = accent === 'US';
            const langCode = isUS ? 'en-US' : 'en-GB';
            
            // Prefer√™ncias
            const genderKeywords = isUS 
                ? ["Male", "David", "Guy", "Mark"]  // EUA -> Masculino
                : ["Female", "Susan", "Zira", "Hazel"]; // UK -> Feminino

            // 1. Tenta achar idioma + g√™nero preferido
            let bestMatch = voices.find(v => {
                return v.lang === langCode && genderKeywords.some(k => v.name.includes(k));
            });

            if (bestMatch) return bestMatch;

            // 2. Se n√£o achar, tenta Google espec√≠fico (Google US costuma ser Female, Google UK Female)
            // Mas vamos tentar respeitar o idioma pelo menos
            return voices.find(v => v.lang === langCode) || voices.find(v => v.lang.startsWith('en'));
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollToBottom() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }

        function changeFontSize(delta) {
            currentFontSize += delta;
            if (currentFontSize < 0.8) currentFontSize = 0.8;
            if (currentFontSize > 2.5) currentFontSize = 2.5;
            document.documentElement.style.setProperty('--line-font-size', `${currentFontSize}rem`);
            localStorage.setItem('englishAppFontSize', currentFontSize);
        }

        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cards));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_ingles_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if(confirm(`Encontrados ${data.length} cart√µes. Substituir?`)) {
                            cards = data; saveCards(); renderCards(); alert("Restaurado!");
                        }
                    } else { alert("Arquivo inv√°lido."); }
                } catch(err) { alert("Erro ao ler arquivo."); }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if(confirm("ATEN√á√ÉO: Isso apagar√° TODOS os cart√µes.\n\nTem certeza?")) {
                if(confirm("Confirma√ß√£o final: Deseja zerar o app?")) {
                    localStorage.clear();
                    cards = [];
                    currentFontSize = 1.15;
                    document.documentElement.style.setProperty('--line-font-size', '1.15rem');
                    renderCards();
                    alert("App zerado.");
                }
            }
        }

        function normalizeFormatting(text) {
            if (!text) return '';
            let t = text;
            t = t.replace(/\*\*(.*?)\*\*/g, '^$1^');
            t = t.replace(/__(.*?)__/g, '^$1^');
            t = t.replace(/<b>(.*?)<\/b>/gi, '^$1^');
            t = t.replace(/<strong>(.*?)<\/strong>/gi, '^$1^');
            t = t.replace(/_(.*?)_/g, '*$1*'); 
            return t;
        }

        function loadCards() {
            const savedFont = localStorage.getItem('englishAppFontSize');
            if (savedFont) {
                currentFontSize = parseFloat(savedFont);
                document.documentElement.style.setProperty('--line-font-size', `${currentFontSize}rem`);
            }
            const saved = localStorage.getItem(STORAGE_KEY);
            const savedOld = localStorage.getItem('englishCardsFinalV21');
            if (saved) { cards = JSON.parse(saved); } 
            else if (savedOld) { cards = JSON.parse(savedOld); saveCards(); }
            else { cards = [{ id: 1, phrase: "My group is ^disbanding^.\nMy team is splitting up.", translation: "Exemplo", accent: 'US' }]; }
            renderCards();
            setTimeout(() => {
                const lastPos = localStorage.getItem('englishAppLastPos');
                if (lastPos) {
                    const el = document.getElementById(`card-${lastPos}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }
        function saveCards() { localStorage.setItem(STORAGE_KEY, JSON.stringify(cards)); }

        function renderCards() {
            const container = document.getElementById('card-container');
            container.innerHTML = '';
            
            cards.forEach((card, index) => {
                const el = document.createElement('div');
                el.className = 'card';
                el.id = `card-${index}`;
                observer.observe(el);

                const color = borderColors[index % borderColors.length];
                el.style.borderLeftColor = color;

                const currentAccent = card.accent || 'US';
                const lines = card.phrase.split('\n');
                let phrasesHtml = '';
                
                lines.forEach(line => {
                    if(line.trim() === "") return;
                    const display = formatHighlight(line);
                    const clean = cleanTextForAudio(line);
                    phrasesHtml += `
                        <div class="line-item">
                            <button class="play-mini" onclick="speakText('${clean.replace(/'/g, "\\'")}', ${index})">üîà</button>
                            <div class="line-text">${display}</div>
                        </div>
                    `;
                });

                let transContent = card.translation 
                    ? `<div class="translation-text">${card.translation}</div>`
                    : `<button class="translate-action-btn" onclick="translateCardNow(${index})" style="width:100%">‚ú® Traduzir Agora</button><div id="trans-text-${index}" class="translation-text"></div>`;

                el.innerHTML = `
                    <div class="card-number">#${index + 1}</div>
                    <div class="card-top-actions">
                        <button class="edit-btn" onclick="enableEditMode(${index})" title="Editar">‚úèÔ∏è</button>
                    </div>
                    <div id="view-mode-${index}">
                        <div class="phrases-area">${phrasesHtml}</div>
                        <div class="card-footer">
                            <div class="controls-group">
                                <div><span class="control-label">Sotaque:</span>
                                    <select id="accent-${index}" class="control-select" onchange="updateCardSettings(${index})">
                                        <option value="US" ${currentAccent === 'US' ? 'selected' : ''}>üá∫üá∏ EUA</option>
                                        <option value="UK" ${currentAccent === 'UK' ? 'selected' : ''}>üá¨üáß UK</option>
                                    </select>
                                </div>
                                <div><span class="control-label">Vel:</span>
                                    <select id="speed-${index}" class="control-select">
                                        <option value="0.8">0.8x</option>
                                        <option value="1" selected>1.0x</option>
                                        <option value="1.1">1.1x</option>
                                        <option value="1.2">1.2x</option>
                                        <option value="1.3">1.3x</option>
                                        <option value="1.5">1.5x</option>
                                        <option value="2">2.0x</option>
                                    </select>
                                </div>
                                <button class="play-all-btn" onclick="speakAll(${index})">‚ñ∂ Ouvir Tudo</button>
                            </div>
                            <button class="delete-btn" onclick="deleteCard(${index})">üóëÔ∏è</button>
                        </div>
                        <button class="toggle-btn" onclick="toggleDetails(this)">üëÅÔ∏è Ver Tradu√ß√£o</button>
                        <div class="details-area">${transContent}</div>
                    </div>

                    <div id="edit-mode-${index}" style="display:none;">
                        <div class="edit-toolbar">
                            <button class="color-btn btn-smart" id="btn-smart-${index}" onclick="autoSmartMark(${index})">üîó Auto Smart</button>
                            <span style="color:#cbd5e1">|</span>
                            <button class="color-btn btn-blue" onclick="applyHighlight(${index}, '*')">Blue</button>
                            <button class="color-btn btn-red" onclick="applyHighlight(${index}, '#')">Red</button>
                            <button class="color-btn btn-lilac" onclick="applyHighlight(${index}, '~')">Lilac</button>
                            <button class="color-btn btn-bold" onclick="applyHighlight(${index}, '^')">Bold</button>
                        </div>
                        
                        <textarea id="edit-phrase-${index}" rows="6" class="edit-mode-area"></textarea>
                        
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <button class="color-btn btn-secondary" onclick="toggleTransEdit(${index})">üìù Ver/Editar Tradu√ß√£o</button>
                            <button class="color-btn btn-secondary" onclick="updateTranslationInEdit(${index})">‚ú® Traduzir/Atualizar</button>
                        </div>

                        <div id="edit-trans-wrapper-${index}" style="display:none;">
                            <textarea id="edit-trans-${index}" rows="5" class="edit-mode-area"></textarea>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="save-btn" onclick="saveEdit(${index})">Salvar</button>
                            <button class="cancel-btn" onclick="cancelEdit(${index})">Cancelar</button>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function updateCardSettings(index) {
            const accentSelect = document.getElementById(`accent-${index}`);
            cards[index].accent = accentSelect.value;
            saveCards();
        }

        function speakText(text, index) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const rate = document.getElementById(`speed-${index}`).value;
                const accent = document.getElementById(`accent-${index}`).value;
                const u = new SpeechSynthesisUtterance(text);
                
                // VOZ COM G√äNERO
                const voice = getVoiceByAccent(accent);
                if (voice) u.voice = voice;
                
                u.lang = accent === 'US' ? 'en-US' : 'en-GB';
                u.rate = parseFloat(rate);
                window.speechSynthesis.speak(u);
            }
        }
        function speakAll(index) {
            const clean = cleanTextForAudio(cards[index].phrase).replace(/\n/g, '. ');
            speakText(clean, index);
        }

        function enableEditMode(i) {
            document.getElementById(`view-mode-${i}`).style.display='none';
            document.getElementById(`edit-mode-${i}`).style.display='block';
            document.querySelector(`#card-${i} .card-top-actions`).style.display='none';

            const pArea = document.getElementById(`edit-phrase-${i}`);
            const tArea = document.getElementById(`edit-trans-${i}`);
            const tWrapper = document.getElementById(`edit-trans-wrapper-${i}`);

            tWrapper.style.display = 'none';
            pArea.value = cards[i].phrase.split('\n').filter(l=>l.trim()).join('\n\n');
            tArea.value = cards[i].translation.split('\n').filter(l=>l.trim()).join('\n\n');
        }

        function toggleTransEdit(index) {
            const wrapper = document.getElementById(`edit-trans-wrapper-${index}`);
            wrapper.style.display = wrapper.style.display === 'none' ? 'block' : 'none';
        }

        async function updateTranslationInEdit(index) {
            const phraseText = document.getElementById(`edit-phrase-${index}`).value;
            const transArea = document.getElementById(`edit-trans-${index}`);
            const wrapper = document.getElementById(`edit-trans-wrapper-${index}`);
            wrapper.style.display = 'block'; 
            transArea.value = "Traduzindo...";
            transArea.value = await fetchTranslation(phraseText);
        }

        function cancelEdit(i) { renderCards(); }
        function saveEdit(i) {
            const rawPhrase = document.getElementById(`edit-phrase-${i}`).value;
            cards[i].phrase = normalizeFormatting(rawPhrase); 
            cards[i].translation = document.getElementById(`edit-trans-${i}`).value;
            saveCards(); renderCards();
        }
        
        // --- AUTO SMART COM TRADU√á√ÉO E FLEXIBILIDADE ---
        async function autoSmartMark(index) {
            const textarea = document.getElementById(`edit-phrase-${index}`);
            const btn = document.getElementById(`btn-smart-${index}`);
            let text = textarea.value;
            let lines = text.split('\n').filter(l => l.trim() !== '');

            if (lines.length < 1) return;

            const match = lines[0].match(/\^(.*?)\^/);
            if (!match) {
                alert("Marque o termo principal em NEGRITO na linha 1 primeiro.");
                return;
            }
            const term = match[1].replace(/[.,!?;:]/g, ''); 

            const originalBtnText = btn.innerText;
            btn.innerText = "‚è≥ Triangulando...";
            btn.disabled = true;

            try {
                // LISTA DE PALAVRAS CHAVE
                let keywords = [term];

                // 1. Sin√¥nimos em Ingl√™s (Datamuse)
                const datamuseRes = await fetch(`https://api.datamuse.com/words?ml=${encodeURIComponent(term)}&max=10`);
                const dmData = await datamuseRes.json();
                dmData.forEach(i => keywords.push(i.word));

                // 2. TRADU√á√ÉO (EN -> PT) (A M√°gica do Pedido)
                // "Disbanding" -> "separando"
                const ptRes = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(term)}&langpair=en|pt-BR`);
                const ptData = await ptRes.json();
                
                if (ptData.responseData && ptData.responseData.translatedText) {
                    const termoPT = ptData.responseData.translatedText;
                    
                    // 3. TRADU√á√ÉO DE VOLTA (PT -> EN)
                    // "Separando" -> "Splitting", "Separating", "Breaking up"
                    // Isso pega a "ideia" e traz de volta pro ingl√™s
                    // Como MyMemory d√° s√≥ 1, vamos tentar usar o Datamuse novamente mas √© dif√≠cil cruzar l√≠nguas.
                    // Vamos usar uma estrat√©gia de "Tokens". Se a tradu√ß√£o PT tem palavras comuns, pode ajudar.
                    
                    // Como n√£o temos API de sin√¥nimo PT f√°cil gr√°tis, vamos confiar no Datamuse EN que j√° pegou "split" de "disband".
                    // O segredo agora √© o MATCHING FLEX√çVEL (Stemming na for√ßa bruta).
                }

                // Palavras individuais do termo original
                const words = term.split(/\s+/);
                words.forEach(w => {
                    if(w.length > 3) keywords.push(w);
                });

                // Limpeza e Unifica√ß√£o
                keywords = [...new Set(keywords.map(k => k.toLowerCase()))];

                // 4. APLICA√á√ÉO INTELIGENTE (Busca Radical)
                // Procura na linha se alguma palavra cont√©m a raiz das keywords
                // Ex: Keyword "split" d√° match em "splitting"
                
                if (lines.length > 1) lines[1] = smartReplace(lines[1], keywords, '*');
                if (lines.length > 2) lines[2] = smartReplace(lines[2], keywords, '#');

                textarea.value = lines.join('\n\n');

            } catch (error) {
                console.error(error);
                alert("Erro na an√°lise.");
            } finally {
                btn.innerText = originalBtnText;
                btn.disabled = false;
            }
        }

        function smartReplace(sentence, keywords, symbol) {
            let clean = sentence.replace(/[*#~]/g, '');
            
            // Ordena keywords por tamanho (maiores primeiro)
            keywords.sort((a, b) => b.length - a.length);

            // Para cada keyword, tenta achar uma "variante" na frase
            // Ex: keyword="split", frase="splitting". Match!
            
            // Quebra frase em palavras para analisar
            const phraseWords = clean.split(/(\s+|[.,!?;:])/); // Mant√©m separadores
            
            const processed = phraseWords.map(word => {
                const wLow = word.toLowerCase();
                // Verifica se essa palavra contem alguma keyword ou √© contida por ela
                const isMatch = keywords.some(k => {
                    return (wLow.includes(k) && k.length > 3) || (k.includes(wLow) && wLow.length > 3); 
                    // Regra de 3 letras para evitar falsos positivos curtos
                });

                if (isMatch && word.trim().length > 0) {
                    return `${symbol}${word}${symbol}`;
                }
                return word;
            });

            // Limpa marca√ß√µes duplicadas vizinhas (**word** **word** -> **word word**)
            let result = processed.join('');
            // Regex para juntar: *word* *word* -> *word word*
            // Apenas visual
            return result;
        }

        function applyHighlight(i, s) {
            const t = document.getElementById(`edit-phrase-${i}`);
            const start = t.selectionStart; const end = t.selectionEnd;
            if (start === end) return alert("Selecione texto!");
            const txt = t.value.substring(start, end).replace(/[*#~^]/g, '');
            t.setRangeText(`${s}${txt}${s}`, start, end, 'select');
        }

        function formatHighlight(t) {
            if(!t) return '';
            let h = t.replace(/\*(.*?)\*/g, '<span class="hl-base hl-blue">$1</span>');
            h = h.replace(/#(.*?)#/g, '<span class="hl-base hl-red">$1</span>');
            h = h.replace(/~(.*?)~/g, '<span class="hl-base hl-lilac">$1</span>');
            h = h.replace(/\^(.*?)\^/g, '<span class="hl-base hl-bold">$1</span>');
            return h;
        }
        function cleanTextForAudio(t) {
            if(!t) return '';
            let c = t.replace(/[*#~^]/g, '');
            return c.replace(/^(Example|Another example|Ex|Ex\.|Exemplo)[:.-]?\s*/gi, '').trim();
        }

        async function fetchTranslation(text) {
            if (!text.trim()) return "";
            try {
                const lines = text.split('\n'); const tr = [];
                for (let l of lines) {
                    if (!l.trim()) { tr.push(""); continue; }
                    const cl = l.replace(/[*#~^]/g, '');
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cl)}&langpair=en|pt-BR`);
                    const d = await res.json();
                    tr.push(d.responseData ? d.responseData.translatedText : "Erro");
                }
                return tr.join('\n');
            } catch (e) { return "Erro conex√£o"; }
        }
        async function translateForm() { document.getElementById('input-translation').value = await fetchTranslation(document.getElementById('input-phrase').value); }
        async function translateCardNow(i) {
            const res = await fetchTranslation(cards[i].phrase);
            cards[i].translation = res; saveCards(); renderCards();
        }
        
        function addCard() {
            const rawPhrase = document.getElementById('input-phrase').value.trim();
            const t = document.getElementById('input-translation').value.trim();
            if(!rawPhrase) return alert("Vazio!");
            const formattedPhrase = normalizeFormatting(rawPhrase);
            cards.unshift({ id: Date.now(), phrase: formattedPhrase, translation: t, accent: 'US' });
            saveCards(); renderCards();
            document.getElementById('input-phrase').value=''; document.getElementById('input-translation').value='';
        }

        function processBulkImport() {
            const r = document.getElementById('import-area').value;
            r.split(/\n\s*\n/).forEach(b=>{
                if(b.trim()) {
                    const formatted = normalizeFormatting(b.trim());
                    cards.unshift({id:Date.now()+Math.random(), phrase:formatted, translation:"", accent:'US'});
                }
            });
            saveCards(); renderCards(); toggleImportArea();
        }

        function deleteCard(i) { if(confirm("Excluir?")) { cards.splice(i,1); saveCards(); renderCards(); }}
        function toggleDetails(btn) { btn.nextElementSibling.classList.toggle('visible'); }
        function toggleImportArea() { const d=document.getElementById('import-section'); d.style.display=d.style.display==='block'?'none':'block'; }

        loadCards();
    </script>
</body>
</html>